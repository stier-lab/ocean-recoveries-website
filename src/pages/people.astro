---
import Layout from '@layouts/Layout.astro';
import PersonCard from '@components/people/PersonCard.astro';
import BreadcrumbSchema from '@components/seo/BreadcrumbSchema.astro';
import { currentTeam, alumni } from '@data/team';

// Sort team by order
const sortedTeam = [...currentTeam].sort((a, b) => a.order - b.order);

// Role labels for display
const roleLabels: Record<string, string> = {
  pi: 'Principal Investigator',
  postdoc: 'Postdoctoral Researchers',
  phd: 'PhD Students',
  manager: 'Lab Staff',
  undergrad: 'Undergraduate Researchers',
};

// Get unique roles in order with counts
const roles = ['pi', 'postdoc', 'phd', 'manager', 'undergrad'].filter(
  role => sortedTeam.some(member => member.role === role)
);

// Count members per role
const roleCounts: Record<string, number> = {};
roles.forEach(role => {
  roleCounts[role] = sortedTeam.filter(m => m.role === role).length;
});

// Alumni role colors (for visual distinction)
const alumniRoleColors: Record<string, string> = {
  'Postdoc': 'teal',
  'PhD': 'sky',
  'MS Student': 'sky',
  'Lab Manager': 'amber',
  'Undergraduate Researcher': 'warm',
};
---

<Layout
  title="People"
  description="Meet the Ocean Recoveries Lab team - researchers studying coral reef and kelp forest recovery at UC Santa Barbara."
  image="/images/research-team-group-photo-beach.jpeg"
  keywords={['research team', 'marine scientists', 'UCSB researchers', 'ocean ecologists', 'Adrian Stier lab']}
>
  <!-- SEO Structured Data -->
  <BreadcrumbSchema
    items={[
      { name: 'People', url: '/people' }
    ]}
  />

  <!-- Hero -->
  <section class="hero-section relative py-20 md:py-28 overflow-hidden">
    <div
      class="absolute inset-0 bg-cover bg-center parallax-bg"
      style="background-image: url('/images/research-team-group-photo-beach.jpeg');"
    >
      <div class="absolute inset-0 bg-navy-deep/55 md:bg-navy-deep/70"></div>
    </div>

    <!-- Floating Bubbles -->
    <div class="floating-bubbles" aria-hidden="true">
      <div class="bubble bubble-1"></div>
      <div class="bubble bubble-2"></div>
      <div class="bubble bubble-3"></div>
      <div class="bubble bubble-4"></div>
    </div>

    <div class="relative z-10 container text-center text-white">
      <h1 class="hero-title mb-4">
        <span class="gradient-text">Our Team</span>
      </h1>
      <p class="hero-desc text-xl text-white/80 max-w-2xl mx-auto">
        We trace resilience from individual organisms to entire ecosystems—using field experiments,
        models, and synthesis to understand why coastal systems fail and how to help them recover.
      </p>
    </div>
  </section>

  <!-- Current Members - Single Grid -->
  <section class="section bg-surface">
    <div class="container">
      <div class="text-center mb-8 scroll-reveal">
        <span class="eyebrow">Current Members</span>
        <h2>Meet the Lab</h2>
      </div>

      <!-- Role filters -->
      <div class="flex flex-wrap justify-center gap-2 mb-10 scroll-reveal" role="tablist" aria-label="Filter team by role">
        <button class="chip active" data-role="all" data-count={sortedTeam.length} role="tab" aria-selected="true">
          All Team <span class="chip-count">({sortedTeam.length})</span>
        </button>
        {roles.map(role => (
          <button class="chip" data-role={role} data-count={roleCounts[role]} role="tab" aria-selected="false">
            {roleLabels[role]} <span class="chip-count">({roleCounts[role]})</span>
          </button>
        ))}
      </div>

      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6" id="team-grid">
        {sortedTeam.map((member, i) => (
          <div class={`team-member scroll-reveal stagger-${(i % 3) + 1}`} data-role={member.role}>
            <PersonCard {...member} />
          </div>
        ))}
      </div>

      <!-- Empty state -->
      <div id="no-members" class="hidden text-center py-12">
        <p class="text-muted text-lg">No team members found with that role.</p>
        <button class="btn btn-secondary mt-4" id="clear-role-filter">Show All</button>
      </div>
    </div>
  </section>

  <!-- Alumni -->
  <section class="section bg-surface">
    <div class="container">
      <div class="text-center mb-12 scroll-reveal">
        <h2>Where Are They Now?</h2>
        <p class="text-muted mt-4 max-w-2xl mx-auto">Lab alumni have gone on to positions at NOAA, NCEAS, and universities around the world.</p>
      </div>

      <div class="alumni-grid">
        {alumni.map((alum, i) => {
          const roleColor = alumniRoleColors[alum.role] || 'sky';
          return (
            <div class={`alumni-card scroll-reveal stagger-${(i % 6) + 1}`} data-role-color={roleColor}>
              {alum.image ? (
                <img src={alum.image} alt={alum.name} class="alumni-photo" loading="lazy" />
              ) : (
                <div class="alumni-avatar">
                  <span class="alumni-initial">{alum.name.charAt(0)}</span>
                </div>
              )}
              <div class="alumni-info">
                <div class="alumni-header">
                  <span class="alumni-name">{alum.name}</span>
                  {alum.linkedin && (
                    <a
                      href={alum.linkedin}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="linkedin-link"
                      aria-label={`${alum.name}'s LinkedIn`}
                    >
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                      </svg>
                    </a>
                  )}
                </div>
                <span class={`alumni-role-tag role-${roleColor}`}>{alum.role}</span>
                <span class="alumni-years">{alum.years}</span>
                {alum.focus && <span class="alumni-focus">{alum.focus}</span>}
                {alum.currentPosition && (
                  <span class="alumni-current">Now: {alum.currentPosition}</span>
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  <!-- Join CTA -->
  <section class="section bg-navy-deep">
    <div class="container text-center">
      <h2 class="text-white mb-4 scroll-reveal">Interested in Joining?</h2>
      <p class="text-white/70 max-w-xl mx-auto mb-8 scroll-reveal">
        Openings depend on funding. Check our opportunities page for current positions—or
        email with a 1-page pitch if you have your own support.
      </p>
      <a href="/join" class="btn btn-primary magnetic-btn scroll-reveal">
        View Opportunities
      </a>
    </div>
  </section>
</Layout>

<style>
  /* ========================================
     Floating Bubbles
     ======================================== */
  .floating-bubbles {
    @apply absolute inset-0 overflow-hidden pointer-events-none;
    z-index: 1;
  }

  .bubble {
    @apply absolute rounded-full;
    background: radial-gradient(circle at 30% 30%, rgba(56, 189, 248, 0.3), rgba(45, 212, 191, 0.1));
    animation: float-up linear infinite;
    opacity: 0;
  }

  .bubble-1 { width: 20px; height: 20px; left: 15%; animation-duration: 12s; animation-delay: 0s; }
  .bubble-2 { width: 30px; height: 30px; left: 35%; animation-duration: 16s; animation-delay: 2s; }
  .bubble-3 { width: 25px; height: 25px; left: 65%; animation-duration: 14s; animation-delay: 4s; }
  .bubble-4 { width: 18px; height: 18px; left: 85%; animation-duration: 11s; animation-delay: 1s; }

  @keyframes float-up {
    0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
    10% { opacity: 0.6; }
    90% { opacity: 0.6; }
    100% { transform: translateY(-100px) scale(1); opacity: 0; }
  }

  /* ========================================
     Gradient Text
     ======================================== */
  .gradient-text {
    background: linear-gradient(135deg, #ffffff 0%, #38bdf8 40%, #2dd4bf 80%, #38bdf8 100%);
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradient-shift 8s ease-in-out infinite;
  }

  @keyframes gradient-shift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  /* ========================================
     Hero Animation
     ======================================== */
  .hero-title {
    animation: fadeUp 0.8s ease-out forwards;
    opacity: 0;
  }

  .hero-desc {
    animation: fadeUp 0.8s ease-out 0.2s forwards;
    opacity: 0;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .parallax-bg {
    transform: translateZ(0);
    will-change: transform;
  }

  /* Role filter chip styles */
  .chip {
    @apply px-4 py-2 rounded-full text-sm font-medium;
    @apply bg-surface-card border border-line text-muted;
    @apply transition-all duration-200 cursor-pointer;
    @apply focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 focus-visible:ring-offset-surface;
  }

  .chip:hover {
    @apply border-accent text-accent -translate-y-0.5;
  }

  .chip.active {
    @apply bg-accent text-white border-accent;
  }

  .chip-count {
    @apply text-xs opacity-70;
  }

  .chip.active .chip-count {
    @apply opacity-90;
  }

  .team-member.hidden {
    @apply !hidden;
  }

  /* Alumni styles */
  .alumni-grid {
    @apply grid sm:grid-cols-2 lg:grid-cols-3 gap-5;
  }

  .alumni-card {
    @apply flex gap-4 p-5 rounded-xl;
    @apply border border-line;
    @apply transition-all duration-300;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
    backdrop-filter: blur(10px);
  }

  .alumni-card:hover {
    @apply -translate-y-1;
    border-color: rgba(56, 189, 248, 0.4);
    box-shadow:
      0 15px 30px -10px rgba(0, 0, 0, 0.3),
      0 0 20px rgba(56, 189, 248, 0.1);
  }

  .alumni-photo {
    @apply w-14 h-14 rounded-full flex-shrink-0 object-cover;
    @apply border-2 border-line;
  }

  .alumni-avatar {
    @apply w-14 h-14 rounded-full flex-shrink-0;
    @apply bg-accent/20;
    @apply flex items-center justify-center;
    @apply border-2 border-accent/30;
  }

  .alumni-initial {
    @apply text-xl font-bold text-accent;
  }

  .alumni-info {
    @apply flex flex-col gap-1.5 min-w-0;
  }

  .alumni-header {
    @apply flex items-center gap-2;
  }

  .alumni-name {
    @apply text-lg font-extrabold text-ink truncate;
  }

  .linkedin-link {
    @apply p-1.5 rounded-md text-muted hover:text-[#0077B5] hover:bg-[#0077B5]/10;
    @apply transition-all flex-shrink-0;
  }

  /* Role tags with color variants */
  .alumni-role-tag {
    @apply inline-flex px-2 py-0.5 rounded-md text-xs font-bold uppercase tracking-wide;
    @apply w-fit;
  }

  .role-teal {
    @apply bg-accent-2/20 text-accent-2;
  }

  .role-sky {
    @apply bg-accent/20 text-accent;
  }

  .role-amber {
    @apply bg-amber-500/20 text-amber-400;
  }

  .role-warm {
    @apply bg-accent-warm/20 text-accent-warm;
  }

  .alumni-years {
    @apply text-xs text-muted-2;
  }

  .alumni-focus {
    @apply text-sm text-muted leading-relaxed line-clamp-2 mt-1;
  }

  .alumni-current {
    @apply text-xs font-medium text-accent-2 mt-1;
  }
</style>

<script>
  const initRoleFilters = () => {
    const chips = document.querySelectorAll('.chip[data-role]') as NodeListOf<HTMLButtonElement>;
    const members = document.querySelectorAll('.team-member');
    const noMembers = document.getElementById('no-members');
    const clearBtn = document.getElementById('clear-role-filter');

    const filterByRole = (role: string, updateUrl = true) => {
      let visibleCount = 0;

      members.forEach((member) => {
        const memberRole = (member as HTMLElement).dataset.role;
        const show = role === 'all' || memberRole === role;

        member.classList.toggle('hidden', !show);
        if (show) visibleCount++;
      });

      // Show/hide empty state
      noMembers?.classList.toggle('hidden', visibleCount > 0);

      // Update active chip and ARIA states
      chips.forEach((chip) => {
        const isActive = chip.dataset.role === role;
        chip.classList.toggle('active', isActive);
        chip.setAttribute('aria-selected', isActive.toString());
      });

      // Update URL without page reload
      if (updateUrl) {
        const url = new URL(window.location.href);
        if (role === 'all') {
          url.searchParams.delete('role');
        } else {
          url.searchParams.set('role', role);
        }
        window.history.replaceState({}, '', url.toString());
      }
    };

    // Keyboard navigation for filter chips
    const handleKeyDown = (e: KeyboardEvent, currentChip: HTMLButtonElement) => {
      const chipsArray = Array.from(chips);
      const currentIndex = chipsArray.indexOf(currentChip);
      let nextIndex = currentIndex;

      switch (e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          e.preventDefault();
          nextIndex = (currentIndex + 1) % chipsArray.length;
          break;
        case 'ArrowLeft':
        case 'ArrowUp':
          e.preventDefault();
          nextIndex = (currentIndex - 1 + chipsArray.length) % chipsArray.length;
          break;
        case 'Home':
          e.preventDefault();
          nextIndex = 0;
          break;
        case 'End':
          e.preventDefault();
          nextIndex = chipsArray.length - 1;
          break;
        default:
          return;
      }

      chipsArray[nextIndex].focus();
    };

    chips.forEach((chip) => {
      chip.addEventListener('click', () => {
        const role = chip.dataset.role || 'all';
        filterByRole(role);
      });

      chip.addEventListener('keydown', (e) => handleKeyDown(e, chip));
    });

    clearBtn?.addEventListener('click', () => filterByRole('all'));

    // Check URL for initial filter
    const urlParams = new URLSearchParams(window.location.search);
    const initialRole = urlParams.get('role') || 'all';

    // Validate that the role exists
    const validRoles = Array.from(chips).map(c => c.dataset.role);
    if (validRoles.includes(initialRole)) {
      filterByRole(initialRole, false);
    }
  };

  initRoleFilters();
  document.addEventListener('astro:after-swap', initRoleFilters);
</script>
