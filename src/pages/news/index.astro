---
import Layout from '@layouts/Layout.astro';
import { posts } from '@data/posts';

// Sort posts by date (newest first)
const sortedPosts = [...posts].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Get unique tags with counts
const tagCounts = posts.reduce((acc, post) => {
  post.tags.forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

// Separate year tags from topic tags
const yearTags = Object.keys(tagCounts).filter(tag => /^\d{4}$/.test(tag)).sort((a, b) => Number(b) - Number(a));
const topicTags = Object.keys(tagCounts).filter(tag => !/^\d{4}$/.test(tag) && tag !== 'Publication').sort();

// Topic category config with colors
const topicConfig: Record<string, { color: string; label: string }> = {
  'Coral': { color: '#f97316', label: 'Coral Reefs' },
  'Kelp': { color: '#22c55e', label: 'Kelp Forests' },
  'Climate': { color: '#ef4444', label: 'Climate Change' },
  'Conservation': { color: '#3b82f6', label: 'Conservation' },
  'Ecology': { color: '#10b981', label: 'Ecology' },
  'Symbiosis': { color: '#8b5cf6', label: 'Symbiosis' },
  'Fisheries': { color: '#06b6d4', label: 'Fisheries' },
  'Management': { color: '#f59e0b', label: 'Management' },
  'Recovery': { color: '#14b8a6', label: 'Recovery' },
};

const getTopicColor = (tags: string[]) => {
  const topic = tags.find(t => topicConfig[t]);
  return topic ? topicConfig[topic].color : '#38bdf8';
};

// Format date
const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

// Calculate reading time
const getReadingTime = (content: string) => {
  const words = content.split(/\s+/).length;
  return Math.max(1, Math.ceil(words / 200));
};

// Get display tags (non-year, non-Publication)
const getDisplayTags = (tags: string[]) => {
  return tags.filter(t => !/^\d{4}$/.test(t) && t !== 'Publication');
};

// Featured posts
const featuredPost = sortedPosts[0];
const secondaryPosts = sortedPosts.slice(1, 3);
const allPosts = sortedPosts.slice(3);

// Stats
const totalArticles = posts.length;
const oaCount = posts.filter(p => p.openAccess).length;
const yearSpan = yearTags.length > 0 ? `${yearTags[yearTags.length - 1]}–${yearTags[0]}` : '';
---

<Layout
  title="News & Research"
  description="Latest news, research updates, and stories from the Ocean Recoveries Lab at UC Santa Barbara."
>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Hero Section -->
  <section class="hero" aria-label="News page introduction">
    <div class="hero-bg">
      <div class="hero-gradient"></div>
      <div class="hero-pattern"></div>
      <div class="hero-orb hero-orb-1"></div>
      <div class="hero-orb hero-orb-2"></div>
    </div>

    <div class="container hero-content">
      <div class="hero-badge">
        <span class="badge-dot"></span>
        <span>Research Updates</span>
      </div>

      <h1 class="hero-title">
        News & <span class="title-gradient">Research</span>
      </h1>

      <p class="hero-subtitle">
        Stories from the frontier of marine ecosystem research. Explore our latest findings on coral reef resilience, kelp forest dynamics, and ocean conservation.
      </p>

      <div class="hero-stats">
        <div class="stat">
          <span class="stat-value">{totalArticles}</span>
          <span class="stat-label">Articles</span>
        </div>
        <div class="stat-divider"></div>
        <div class="stat">
          <span class="stat-value">{oaCount}</span>
          <span class="stat-label">Open Access</span>
        </div>
        <div class="stat-divider"></div>
        <div class="stat">
          <span class="stat-value">{yearSpan}</span>
          <span class="stat-label">Research Years</span>
        </div>
      </div>
    </div>

    <div class="hero-wave">
      <svg viewBox="0 0 1440 120" fill="none" preserveAspectRatio="none">
        <path d="M0 120L60 110C120 100 240 80 360 70C480 60 600 60 720 65C840 70 960 80 1080 85C1200 90 1320 90 1380 90L1440 90V120H1380C1320 120 1200 120 1080 120C960 120 840 120 720 120C600 120 480 120 360 120C240 120 120 120 60 120H0Z" fill="#0f172a"/>
      </svg>
    </div>
  </section>

  <!-- Featured Section -->
  <section class="featured-section" aria-label="Featured articles">
    <div class="container">
      <div class="featured-grid">
        <!-- Main Featured -->
        <article class="featured-main" data-reveal>
          <a href={`/news/${featuredPost.slug}`} class="featured-link">
            <div class="featured-image">
              <img src={featuredPost.featuredImage} alt="" loading="eager" />
              <div class="featured-overlay"></div>
            </div>
            <div class="featured-content">
              <div class="featured-badges">
                <span class="badge-latest">Latest</span>
                {featuredPost.openAccess && <span class="badge-oa">Open Access</span>}
              </div>
              <div class="featured-tags">
                {getDisplayTags(featuredPost.tags).slice(0, 2).map(tag => (
                  <span class="featured-tag" style={`--tag-color: ${topicConfig[tag]?.color || '#38bdf8'}`}>{tag}</span>
                ))}
              </div>
              <h2 class="featured-title">{featuredPost.title}</h2>
              <p class="featured-excerpt">{featuredPost.excerpt}</p>
              <div class="featured-meta">
                <span class="meta-author">{featuredPost.author}</span>
                <span class="meta-sep">·</span>
                <time datetime={featuredPost.date}>{formatDate(featuredPost.date)}</time>
                <span class="meta-sep">·</span>
                <span>{getReadingTime(featuredPost.content)} min read</span>
              </div>
            </div>
          </a>
          {(featuredPost.pdfUrl || featuredPost.doiUrl) && (
            <div class="featured-actions">
              {featuredPost.pdfUrl && (
                <a href={featuredPost.pdfUrl} target="_blank" rel="noopener noreferrer" class="action-btn action-pdf">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  PDF
                </a>
              )}
              {featuredPost.doiUrl && (
                <a href={featuredPost.doiUrl} target="_blank" rel="noopener noreferrer" class="action-btn action-doi">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                  Paper
                </a>
              )}
            </div>
          )}
        </article>

        <!-- Secondary Featured -->
        <div class="featured-secondary">
          {secondaryPosts.map((post, i) => (
            <article class="secondary-card" data-reveal style={`--delay: ${0.1 + i * 0.1}s`}>
              <a href={`/news/${post.slug}`} class="secondary-link">
                <div class="secondary-image">
                  <img src={post.featuredImage} alt="" loading="lazy" />
                  {post.openAccess && <span class="oa-badge">OA</span>}
                </div>
                <div class="secondary-content">
                  <span class="secondary-tag" style={`--tag-color: ${getTopicColor(post.tags)}`}>
                    {getDisplayTags(post.tags)[0] || 'Research'}
                  </span>
                  <h3 class="secondary-title">{post.title}</h3>
                  <div class="secondary-meta">
                    <time datetime={post.date}>{formatDate(post.date)}</time>
                    <span>·</span>
                    <span>{getReadingTime(post.content)} min</span>
                  </div>
                </div>
              </a>
            </article>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Filters Bar -->
  <section class="filters-bar" aria-label="Filter articles">
    <div class="container">
      <div class="filters-inner">
        <!-- Search -->
        <div class="search-box">
          <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="search"
            id="search-input"
            placeholder="Search articles..."
            class="search-input"
            aria-label="Search articles"
          />
          <button id="clear-search" class="clear-btn hidden" aria-label="Clear search">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Topic Pills -->
        <div class="filter-pills" role="group" aria-label="Topic filters">
          <button class="pill active" data-tag="all" aria-pressed="true">All</button>
          {topicTags.slice(0, 6).map(topic => (
            <button
              class="pill"
              data-tag={topic}
              style={`--pill-color: ${topicConfig[topic]?.color || '#38bdf8'}`}
              aria-pressed="false"
            >
              {topic}
            </button>
          ))}
        </div>

        <!-- Controls -->
        <div class="filter-controls">
          <!-- Year Dropdown -->
          <div class="dropdown">
            <button class="dropdown-trigger" id="year-btn" aria-haspopup="listbox" aria-expanded="false">
              <span class="dropdown-text">Year</span>
              <svg class="dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="dropdown-menu" id="year-panel" role="listbox">
              {yearTags.map(year => (
                <button class="dropdown-item" data-tag={year} role="option" aria-selected="false">
                  {year}
                </button>
              ))}
            </div>
          </div>

          <!-- OA Toggle -->
          <button class="oa-toggle" id="oa-filter" aria-pressed="false" title="Open Access only">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
            </svg>
            <span>Open Access</span>
          </button>

          <!-- Sort -->
          <select id="sort-select" class="sort-select" aria-label="Sort articles">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
      </div>

      <!-- Active Filters & Results -->
      <div class="filters-meta">
        <div class="active-filters" id="active-filters" role="status" aria-live="polite"></div>
        <span class="results-count" id="results-text">{sortedPosts.length} articles</span>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main id="main-content" class="articles-section">
    <div class="container">
      <!-- Articles Grid -->
      <div class="articles-grid" id="articles-grid">
        {allPosts.map((post, i) => (
          <article
            class="article-card"
            data-tags={post.tags.join(',')}
            data-title={post.title.toLowerCase()}
            data-excerpt={post.excerpt.toLowerCase()}
            data-open-access={post.openAccess ? 'true' : 'false'}
            data-date={post.date}
            data-reveal
            style={`--delay: ${(i % 9) * 0.05}s`}
          >
            <a href={`/news/${post.slug}`} class="card-link">
              <div class="card-image">
                <img src={post.featuredImage} alt="" loading="lazy" />
                {post.openAccess && (
                  <span class="card-oa" title="Open Access">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                    </svg>
                  </span>
                )}
              </div>
              <div class="card-body">
                <div class="card-top">
                  <span class="card-tag" style={`--tag-color: ${getTopicColor(post.tags)}`}>
                    {getDisplayTags(post.tags)[0] || 'Research'}
                  </span>
                  <time datetime={post.date} class="card-date">{formatDate(post.date)}</time>
                </div>
                <h3 class="card-title">{post.title}</h3>
                <p class="card-excerpt">{post.excerpt}</p>
              </div>
            </a>
            <div class="card-footer">
              <span class="card-author">{post.author}</span>
              <div class="card-actions">
                {post.pdfUrl && (
                  <a href={post.pdfUrl} target="_blank" rel="noopener noreferrer" class="card-action card-action-pdf">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>PDF</span>
                  </a>
                )}
                {post.doiUrl && (
                  <a href={post.doiUrl} target="_blank" rel="noopener noreferrer" class="card-action card-action-doi">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    <span>Paper</span>
                  </a>
                )}
              </div>
            </div>
          </article>
        ))}
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="empty-state hidden" role="status">
        <div class="empty-icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <h3 class="empty-title">No articles found</h3>
        <p class="empty-text">Try adjusting your search or filters</p>
        <button class="empty-btn" id="clear-all">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Reset filters
        </button>
      </div>

      <!-- Load More -->
      <div class="load-more" id="load-more">
        <button class="load-btn" id="load-btn">
          <span class="load-text">Load more articles</span>
          <span class="load-spinner hidden">
            <svg class="animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
          <svg class="load-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <span class="load-count" id="load-count"></span>
      </div>
    </div>
  </main>

  <!-- CTA Section -->
  <section class="cta-section" aria-labelledby="cta-heading">
    <div class="container">
      <div class="cta-card" data-reveal>
        <div class="cta-content">
          <h2 id="cta-heading" class="cta-title">Stay connected with our research</h2>
          <p class="cta-text">Follow our work on coral reef resilience and kelp forest ecosystems</p>
        </div>
        <div class="cta-actions">
          <a href="https://twitter.com/staboratory" target="_blank" rel="noopener noreferrer" class="cta-btn cta-twitter">
            <svg fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            Twitter
          </a>
          <a href="https://scholar.google.com/citations?user=bxbOvMgAAAAJ" target="_blank" rel="noopener noreferrer" class="cta-btn cta-scholar">
            <svg fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 24a7 7 0 110-14 7 7 0 010 14zm0-24L0 9.5l4.838 3.94A8 8 0 0112 9a8 8 0 017.162 4.44L24 9.5z"/>
            </svg>
            Google Scholar
          </a>
          <a href="/publications" class="cta-btn cta-pubs">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Publications
          </a>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Skip Link */
  .skip-link {
    @apply absolute left-4 top-4 z-[100] px-4 py-2 rounded-lg font-medium;
    @apply bg-accent text-white no-underline;
    @apply transform -translate-y-20 opacity-0;
    @apply focus:translate-y-0 focus:opacity-100;
    @apply transition-all duration-200;
  }

  /* Hero Section */
  .hero {
    @apply relative pt-24 pb-32 overflow-hidden;
    background: linear-gradient(135deg, #0a1628 0%, #0f172a 50%, #1a2744 100%);
  }

  .hero-bg {
    @apply absolute inset-0 overflow-hidden;
  }

  .hero-gradient {
    @apply absolute inset-0;
    background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(56, 189, 248, 0.12) 0%, transparent 60%);
  }

  .hero-pattern {
    @apply absolute inset-0 opacity-[0.03];
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }

  .hero-orb {
    @apply absolute rounded-full blur-3xl;
  }

  .hero-orb-1 {
    @apply w-96 h-96 -top-48 -right-24;
    background: radial-gradient(circle, rgba(56, 189, 248, 0.15) 0%, transparent 70%);
    animation: float 20s ease-in-out infinite;
  }

  .hero-orb-2 {
    @apply w-80 h-80 bottom-0 -left-20;
    background: radial-gradient(circle, rgba(45, 212, 191, 0.1) 0%, transparent 70%);
    animation: float 25s ease-in-out infinite reverse;
  }

  @keyframes float {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(20px, -20px); }
  }

  .hero-content {
    @apply relative z-10 text-center max-w-3xl mx-auto;
  }

  .hero-badge {
    @apply inline-flex items-center gap-2 px-4 py-2 mb-6;
    @apply bg-white/5 border border-white/10 rounded-full;
    @apply text-sm font-medium text-white/70;
  }

  .badge-dot {
    @apply w-2 h-2 rounded-full bg-accent;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .hero-title {
    @apply text-4xl md:text-5xl lg:text-6xl font-black text-white mb-6;
    @apply tracking-tight leading-tight;
  }

  .title-gradient {
    background: linear-gradient(135deg, #38bdf8 0%, #2dd4bf 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .hero-subtitle {
    @apply text-lg md:text-xl text-white/60 mb-10 max-w-2xl mx-auto;
    @apply leading-relaxed;
  }

  .hero-stats {
    @apply inline-flex items-center gap-6 md:gap-8 px-8 py-4;
    @apply bg-white/5 border border-white/10 rounded-2xl;
    @apply backdrop-blur-sm;
  }

  .stat {
    @apply text-center;
  }

  .stat-value {
    @apply block text-2xl md:text-3xl font-bold text-white mb-1;
  }

  .stat-label {
    @apply text-xs md:text-sm text-white/50 uppercase tracking-wider;
  }

  .stat-divider {
    @apply w-px h-10 bg-white/10;
  }

  .hero-wave {
    @apply absolute bottom-0 left-0 right-0;
  }

  .hero-wave svg {
    @apply w-full h-20 md:h-28;
  }

  /* Featured Section */
  .featured-section {
    @apply py-12 bg-surface;
  }

  .featured-grid {
    @apply grid lg:grid-cols-5 gap-6;
  }

  .featured-main {
    @apply lg:col-span-3 relative rounded-2xl overflow-hidden;
    @apply bg-surface-card border border-line/50;
    @apply transition-all duration-300;
  }

  .featured-main:hover {
    @apply border-accent/30;
    transform: translateY(-4px);
    box-shadow: 0 20px 60px -15px rgba(0,0,0,0.5);
  }

  .featured-link {
    @apply block no-underline relative min-h-[480px];
    @apply focus:outline-none;
  }

  .featured-image {
    @apply absolute inset-0;
  }

  .featured-image img {
    @apply w-full h-full object-cover transition-transform duration-700;
  }

  .featured-main:hover .featured-image img {
    @apply scale-105;
  }

  .featured-overlay {
    @apply absolute inset-0;
    background: linear-gradient(to top, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0.5) 50%, rgba(15, 23, 42, 0.2) 100%);
  }

  .featured-content {
    @apply absolute bottom-0 left-0 right-0 p-8;
  }

  .featured-badges {
    @apply flex items-center gap-2 mb-4;
  }

  .badge-latest {
    @apply px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide;
    @apply bg-accent text-white;
  }

  .badge-oa {
    @apply px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide;
    @apply bg-green-500/20 text-green-400 border border-green-500/30;
  }

  .featured-tags {
    @apply flex flex-wrap gap-2 mb-4;
  }

  .featured-tag {
    @apply px-3 py-1 rounded-lg text-xs font-medium;
    background: color-mix(in srgb, var(--tag-color) 15%, transparent);
    color: var(--tag-color);
    border: 1px solid color-mix(in srgb, var(--tag-color) 25%, transparent);
  }

  .featured-title {
    @apply text-2xl md:text-3xl font-bold text-white mb-3 leading-tight;
    @apply transition-colors;
  }

  .featured-main:hover .featured-title {
    @apply text-accent;
  }

  .featured-excerpt {
    @apply text-white/60 line-clamp-2 mb-4;
  }

  .featured-meta {
    @apply flex flex-wrap items-center gap-2 text-sm text-white/40;
  }

  .meta-author {
    @apply font-medium text-white/60;
  }

  .meta-sep {
    @apply text-white/20;
  }

  .featured-actions {
    @apply flex items-center gap-3 px-8 py-4;
    @apply border-t border-white/10 bg-black/20 backdrop-blur-sm;
  }

  .action-btn {
    @apply inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium;
    @apply transition-all no-underline;
    @apply focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-surface-card;
  }

  .action-btn svg {
    @apply w-4 h-4;
  }

  .action-pdf {
    @apply bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white;
    @apply focus:ring-red-500/50;
  }

  .action-doi {
    @apply bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white;
    @apply focus:ring-blue-500/50;
  }

  /* Secondary Featured Cards */
  .featured-secondary {
    @apply lg:col-span-2 flex flex-col gap-4;
  }

  .secondary-card {
    @apply flex-1 rounded-xl overflow-hidden;
    @apply bg-surface-card border border-line/50;
    @apply transition-all duration-300;
  }

  .secondary-card:hover {
    @apply border-accent/30;
    transform: translateY(-2px);
    box-shadow: 0 12px 40px -10px rgba(0,0,0,0.4);
  }

  .secondary-link {
    @apply flex gap-4 p-4 h-full no-underline;
    @apply focus:outline-none;
  }

  .secondary-image {
    @apply relative w-28 h-28 md:w-32 md:h-32 flex-shrink-0 rounded-lg overflow-hidden;
  }

  .secondary-image img {
    @apply w-full h-full object-cover transition-transform duration-500;
  }

  .secondary-card:hover .secondary-image img {
    @apply scale-110;
  }

  .oa-badge {
    @apply absolute top-2 right-2 px-2 py-0.5 rounded text-[10px] font-bold;
    @apply bg-green-500 text-white;
  }

  .secondary-content {
    @apply flex flex-col justify-center min-w-0;
  }

  .secondary-tag {
    @apply text-xs font-semibold mb-2;
    color: var(--tag-color);
  }

  .secondary-title {
    @apply text-base md:text-lg font-bold text-ink line-clamp-2 mb-2;
    @apply transition-colors;
  }

  .secondary-card:hover .secondary-title {
    @apply text-accent;
  }

  .secondary-meta {
    @apply flex items-center gap-2 text-xs text-muted;
  }

  /* Filters Bar */
  .filters-bar {
    @apply py-4 bg-surface sticky top-0 z-40;
    @apply border-b border-line/30;
    @apply backdrop-blur-xl;
  }

  .filters-inner {
    @apply flex flex-wrap items-center gap-4;
  }

  .search-box {
    @apply relative flex-shrink-0;
  }

  .search-icon {
    @apply absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted pointer-events-none;
  }

  .search-input {
    @apply w-48 lg:w-56 pl-10 pr-8 py-2.5 rounded-xl text-sm;
    @apply bg-surface-card border border-line text-ink placeholder-muted;
    @apply focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20;
    @apply transition-all;
  }

  .clear-btn {
    @apply absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-lg;
    @apply text-muted hover:text-ink hover:bg-white/5;
    @apply transition-colors cursor-pointer;
  }

  .clear-btn.hidden { @apply invisible opacity-0; }

  .clear-btn svg {
    @apply w-4 h-4;
  }

  .filter-pills {
    @apply flex items-center gap-2 flex-wrap flex-1;
  }

  .pill {
    @apply px-4 py-2 rounded-xl text-sm font-medium;
    @apply bg-transparent border border-line text-muted;
    @apply hover:border-accent/50 hover:text-ink;
    @apply transition-all cursor-pointer;
    @apply focus:outline-none focus:ring-2 focus:ring-accent/30;
  }

  .pill.active {
    @apply bg-accent border-accent text-white;
  }

  .pill:not(.active):hover {
    border-color: var(--pill-color, #38bdf8);
    color: var(--pill-color, #38bdf8);
  }

  .filter-controls {
    @apply flex items-center gap-2;
  }

  .dropdown {
    @apply relative;
  }

  .dropdown-trigger {
    @apply flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium;
    @apply bg-surface-card border border-line text-muted;
    @apply hover:border-accent/50 hover:text-ink;
    @apply transition-all cursor-pointer;
    @apply focus:outline-none focus:ring-2 focus:ring-accent/30;
  }

  .dropdown-arrow {
    @apply w-4 h-4 transition-transform duration-200;
  }

  .dropdown-trigger[aria-expanded="true"] .dropdown-arrow {
    @apply rotate-180;
  }

  .dropdown-menu {
    @apply absolute top-full right-0 mt-2 py-2 min-w-[120px];
    @apply bg-surface-card border border-line rounded-xl shadow-2xl;
    @apply opacity-0 invisible -translate-y-2;
    @apply transition-all duration-200 z-50;
  }

  .dropdown-menu.open {
    @apply opacity-100 visible translate-y-0;
  }

  .dropdown-item {
    @apply block w-full px-4 py-2 text-sm text-muted text-left;
    @apply hover:bg-accent/10 hover:text-accent;
    @apply transition-colors cursor-pointer;
    @apply focus:outline-none focus:bg-accent/10 focus:text-accent;
  }

  .dropdown-item.active {
    @apply bg-accent/10 text-accent;
  }

  .oa-toggle {
    @apply flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium;
    @apply bg-transparent border border-line text-muted;
    @apply hover:border-green-500/50 hover:text-green-400;
    @apply transition-all cursor-pointer;
    @apply focus:outline-none focus:ring-2 focus:ring-green-500/30;
  }

  .oa-toggle svg {
    @apply w-4 h-4;
  }

  .oa-toggle.active {
    @apply bg-green-500 border-green-500 text-white;
  }

  .oa-toggle span {
    @apply hidden md:inline;
  }

  .sort-select {
    @apply px-4 py-2.5 rounded-xl text-sm font-medium;
    @apply bg-surface-card border border-line text-muted;
    @apply focus:outline-none focus:border-accent focus:ring-2 focus:ring-accent/20;
    @apply cursor-pointer;
  }

  .filters-meta {
    @apply flex items-center justify-between mt-3;
  }

  .active-filters {
    @apply flex flex-wrap items-center gap-2;
  }

  .active-filters:empty { @apply hidden; }

  .filter-tag {
    @apply inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium;
    @apply bg-accent/10 text-accent;
  }

  .filter-tag button {
    @apply p-0.5 rounded hover:bg-accent/20 cursor-pointer transition-colors;
  }

  .filter-tag svg {
    @apply w-3 h-3;
  }

  .clear-all-btn {
    @apply text-xs text-muted hover:text-accent cursor-pointer transition-colors ml-2;
  }

  .results-count {
    @apply text-sm text-muted;
  }

  /* Articles Section */
  .articles-section {
    @apply py-12 bg-surface;
  }

  .articles-grid {
    @apply grid sm:grid-cols-2 lg:grid-cols-3 gap-6;
  }

  .article-card {
    @apply bg-surface-card rounded-2xl border border-line/50 overflow-hidden;
    @apply transition-all duration-300;
  }

  .article-card:hover {
    @apply border-accent/30;
    transform: translateY(-4px);
    box-shadow: 0 20px 50px -15px rgba(0,0,0,0.4);
  }

  .article-card:focus-within {
    @apply ring-2 ring-accent/50 ring-offset-2 ring-offset-surface;
  }

  .article-card.hidden { @apply !hidden; }

  .card-link {
    @apply block no-underline focus:outline-none;
  }

  .card-image {
    @apply relative aspect-[16/10] overflow-hidden;
  }

  .card-image img {
    @apply w-full h-full object-cover transition-transform duration-500;
  }

  .article-card:hover .card-image img {
    @apply scale-105;
  }

  .card-oa {
    @apply absolute top-3 right-3 p-2 rounded-full;
    @apply bg-green-500/90 text-white shadow-lg;
  }

  .card-oa svg {
    @apply w-3.5 h-3.5;
  }

  .card-body {
    @apply p-5;
  }

  .card-top {
    @apply flex items-center justify-between mb-3;
  }

  .card-tag {
    @apply text-xs font-semibold uppercase tracking-wide;
    color: var(--tag-color);
  }

  .card-date {
    @apply text-xs text-muted;
  }

  .card-title {
    @apply text-lg font-bold text-ink mb-2 line-clamp-2;
    @apply transition-colors;
  }

  .article-card:hover .card-title {
    @apply text-accent;
  }

  .card-excerpt {
    @apply text-sm text-muted line-clamp-2;
  }

  .card-footer {
    @apply flex items-center justify-between px-5 py-3;
    @apply border-t border-line/50;
  }

  .card-author {
    @apply text-xs text-muted font-medium;
  }

  .card-actions {
    @apply flex items-center gap-1;
  }

  .card-action {
    @apply inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg;
    @apply text-xs font-medium;
    @apply transition-colors no-underline;
    @apply focus:outline-none focus:ring-2;
  }

  .card-action svg {
    @apply w-3.5 h-3.5;
  }

  .card-action-pdf {
    @apply bg-red-500/10 text-red-400;
    @apply hover:bg-red-500 hover:text-white;
    @apply focus:ring-red-500/30;
  }

  .card-action-doi {
    @apply bg-blue-500/10 text-blue-400;
    @apply hover:bg-blue-500 hover:text-white;
    @apply focus:ring-blue-500/30;
  }

  /* Empty State */
  .empty-state {
    @apply text-center py-20;
  }

  .empty-state.hidden { @apply !hidden; }

  .empty-icon {
    @apply mx-auto w-20 h-20 mb-6 flex items-center justify-center;
    @apply bg-surface-card rounded-full border border-line text-muted/30;
  }

  .empty-icon svg {
    @apply w-10 h-10;
  }

  .empty-title {
    @apply text-2xl font-bold text-ink mb-3;
  }

  .empty-text {
    @apply text-muted mb-8;
  }

  .empty-btn {
    @apply inline-flex items-center gap-2 px-6 py-3 rounded-xl font-medium;
    @apply bg-accent text-white hover:bg-accent/90;
    @apply transition-all cursor-pointer;
    @apply focus:outline-none focus:ring-2 focus:ring-accent/50;
  }

  .empty-btn svg {
    @apply w-4 h-4;
  }

  /* Load More */
  .load-more {
    @apply flex flex-col items-center gap-3 pt-12;
  }

  .load-more.hidden { @apply !hidden; }

  .load-btn {
    @apply inline-flex items-center gap-2 px-8 py-4 rounded-xl font-semibold;
    @apply bg-surface-card border-2 border-line text-ink;
    @apply hover:border-accent hover:text-accent hover:bg-accent/5;
    @apply transition-all cursor-pointer;
    @apply focus:outline-none focus:ring-2 focus:ring-accent/50;
  }

  .load-btn svg {
    @apply w-5 h-5;
  }

  .load-btn.loading .load-text,
  .load-btn.loading .load-arrow {
    @apply hidden;
  }

  .load-btn.loading .load-spinner {
    @apply inline-block;
  }

  .load-spinner {
    @apply hidden;
  }

  .load-count {
    @apply text-sm text-muted;
  }

  /* CTA Section */
  .cta-section {
    @apply py-20 bg-surface;
  }

  .cta-card {
    @apply flex flex-col md:flex-row items-center justify-between gap-8;
    @apply p-8 md:p-12 rounded-3xl;
    background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
    border: 1px solid rgba(255,255,255,0.08);
  }

  .cta-content {
    @apply text-center md:text-left;
  }

  .cta-title {
    @apply text-2xl md:text-3xl font-bold text-white mb-2;
  }

  .cta-text {
    @apply text-white/50;
  }

  .cta-actions {
    @apply flex flex-wrap items-center gap-3;
  }

  .cta-btn {
    @apply inline-flex items-center gap-2 px-5 py-3 rounded-xl font-medium;
    @apply transition-all no-underline;
    @apply focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#0f172a];
  }

  .cta-btn svg {
    @apply w-5 h-5;
  }

  .cta-twitter {
    @apply bg-white/10 text-white border border-white/20;
    @apply hover:bg-white/20 focus:ring-white/30;
  }

  .cta-scholar {
    @apply bg-white/10 text-white border border-white/20;
    @apply hover:bg-white/20 focus:ring-white/30;
  }

  .cta-pubs {
    @apply bg-accent text-white;
    @apply hover:bg-accent/90 focus:ring-accent/50;
  }

  /* Reveal Animation */
  [data-reveal] {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease, transform 0.6s ease;
    transition-delay: var(--delay, 0s);
  }

  [data-reveal].revealed {
    opacity: 1;
    transform: translateY(0);
  }

  /* Utility */
  .animate-spin {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .hero-orb,
    .badge-dot,
    [data-reveal] {
      animation: none !important;
      transition: none !important;
      opacity: 1 !important;
      transform: none !important;
    }

    .featured-image img,
    .secondary-image img,
    .card-image img {
      transition: none !important;
    }
  }
</style>

<script>
  const initNewsPage = () => {
    // Elements
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const clearSearch = document.getElementById('clear-search');
    const articlesGrid = document.getElementById('articles-grid');
    const emptyState = document.getElementById('empty-state');
    const activeFiltersEl = document.getElementById('active-filters');
    const resultsText = document.getElementById('results-text');
    const loadMore = document.getElementById('load-more');
    const loadBtn = document.getElementById('load-btn');
    const loadCount = document.getElementById('load-count');
    const clearAllBtn = document.getElementById('clear-all');
    const oaFilter = document.getElementById('oa-filter');
    const yearBtn = document.getElementById('year-btn');
    const yearPanel = document.getElementById('year-panel');
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;

    const allCards = document.querySelectorAll('.article-card');
    const totalCount = allCards.length;

    // State
    let activeTag = 'all';
    let activeYear = '';
    let searchQuery = '';
    let openAccessOnly = false;
    let visibleCount = 12;
    let sortOrder = 'newest';

    // Reveal animations
    const observeReveals = () => {
      const reveals = document.querySelectorAll('[data-reveal]:not(.revealed)');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('revealed');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1, rootMargin: '50px' });

      reveals.forEach(el => observer.observe(el));
    };

    observeReveals();

    // Close dropdowns
    const closeDropdowns = () => {
      yearPanel?.classList.remove('open');
      yearBtn?.setAttribute('aria-expanded', 'false');
    };

    // Year dropdown toggle
    yearBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = yearPanel?.classList.contains('open');
      yearPanel?.classList.toggle('open');
      yearBtn.setAttribute('aria-expanded', String(!isOpen));
    });

    yearBtn?.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeDropdowns();
    });

    document.addEventListener('click', closeDropdowns);

    // Sort posts
    const sortPosts = (cards: Element[]) => {
      return cards.sort((a, b) => {
        const dateA = new Date((a as HTMLElement).dataset.date || '').getTime();
        const dateB = new Date((b as HTMLElement).dataset.date || '').getTime();
        return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
      });
    };

    // Filter posts
    const filterPosts = () => {
      let matchingCards: Element[] = [];

      allCards.forEach((card) => {
        const el = card as HTMLElement;
        const tags = el.dataset.tags?.split(',') || [];
        const title = el.dataset.title || '';
        const excerpt = el.dataset.excerpt || '';
        const isOA = el.dataset.openAccess === 'true';

        const matchesTag = activeTag === 'all' || tags.includes(activeTag);
        const matchesYear = !activeYear || tags.includes(activeYear);
        const matchesSearch = !searchQuery ||
          title.includes(searchQuery.toLowerCase()) ||
          excerpt.includes(searchQuery.toLowerCase());
        const matchesOA = !openAccessOnly || isOA;

        if (matchesTag && matchesYear && matchesSearch && matchesOA) {
          matchingCards.push(card);
        }
      });

      // Sort
      matchingCards = sortPosts(matchingCards);

      // Hide all first
      allCards.forEach(card => card.classList.add('hidden'));

      // Show paginated results
      let shown = 0;
      matchingCards.forEach((card, i) => {
        if (i < visibleCount) {
          card.classList.remove('hidden');
          shown++;
        }
      });

      const total = matchingCards.length;
      const remaining = total - shown;

      // Update UI
      if (resultsText) {
        if (total === 0) {
          resultsText.textContent = 'No results';
        } else if (total === totalCount && shown === total) {
          resultsText.textContent = `${total} articles`;
        } else {
          resultsText.textContent = `${shown} of ${total} articles`;
        }
      }

      if (loadCount) {
        loadCount.textContent = remaining > 0 ? `${remaining} more` : '';
      }

      emptyState?.classList.toggle('hidden', total > 0);
      articlesGrid?.classList.toggle('hidden', total === 0);
      loadMore?.classList.toggle('hidden', remaining <= 0 || total === 0);

      updateActiveFilters();
      observeReveals();
    };

    // Update active filters
    const updateActiveFilters = () => {
      if (!activeFiltersEl) return;

      const filters: { label: string; value: string; type: string }[] = [];

      if (activeTag !== 'all') {
        filters.push({ label: activeTag, value: activeTag, type: 'tag' });
      }
      if (activeYear) {
        filters.push({ label: activeYear, value: activeYear, type: 'year' });
      }
      if (searchQuery) {
        filters.push({ label: `"${searchQuery}"`, value: searchQuery, type: 'search' });
      }
      if (openAccessOnly) {
        filters.push({ label: 'Open Access', value: 'oa', type: 'oa' });
      }

      if (filters.length === 0) {
        activeFiltersEl.innerHTML = '';
        return;
      }

      activeFiltersEl.innerHTML = filters.map(f => `
        <span class="filter-tag">
          ${f.label}
          <button data-type="${f.type}" data-value="${f.value}" aria-label="Remove ${f.label} filter">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </span>
      `).join('') + `<button class="clear-all-btn">Clear all</button>`;

      activeFiltersEl.querySelectorAll('[data-type]').forEach(btn => {
        btn.addEventListener('click', () => {
          const type = (btn as HTMLElement).dataset.type;

          if (type === 'oa') {
            openAccessOnly = false;
            oaFilter?.classList.remove('active');
            oaFilter?.setAttribute('aria-pressed', 'false');
          } else if (type === 'search') {
            searchQuery = '';
            if (searchInput) searchInput.value = '';
            clearSearch?.classList.add('hidden');
          } else if (type === 'year') {
            activeYear = '';
            updateYearButton();
            document.querySelectorAll('.dropdown-item[data-tag]').forEach(opt => {
              opt.classList.remove('active');
              opt.setAttribute('aria-selected', 'false');
            });
          } else if (type === 'tag') {
            activeTag = 'all';
            updatePillStates();
          }

          filterPosts();
        });
      });

      activeFiltersEl.querySelector('.clear-all-btn')?.addEventListener('click', clearAll);
    };

    // Update year button
    const updateYearButton = () => {
      const label = yearBtn?.querySelector('.dropdown-text');
      if (label) {
        label.textContent = activeYear || 'Year';
      }
    };

    // Update pills
    const updatePillStates = () => {
      document.querySelectorAll('.pill[data-tag]').forEach(pill => {
        const isActive = (pill as HTMLElement).dataset.tag === activeTag;
        pill.classList.toggle('active', isActive);
        pill.setAttribute('aria-pressed', String(isActive));
      });
    };

    // Clear all
    const clearAll = () => {
      activeTag = 'all';
      activeYear = '';
      searchQuery = '';
      openAccessOnly = false;
      visibleCount = 12;

      if (searchInput) searchInput.value = '';
      clearSearch?.classList.add('hidden');
      oaFilter?.classList.remove('active');
      oaFilter?.setAttribute('aria-pressed', 'false');

      updatePillStates();
      updateYearButton();

      document.querySelectorAll('.dropdown-item[data-tag]').forEach(opt => {
        opt.classList.remove('active');
        opt.setAttribute('aria-selected', 'false');
      });

      filterPosts();
    };

    // Topic pills
    document.querySelectorAll('.pill[data-tag]').forEach(pill => {
      pill.addEventListener('click', () => {
        activeTag = (pill as HTMLElement).dataset.tag || 'all';
        visibleCount = 12;
        updatePillStates();
        closeDropdowns();
        filterPosts();
      });
    });

    // Year options
    document.querySelectorAll('.dropdown-item[data-tag]').forEach(opt => {
      opt.addEventListener('click', () => {
        const year = (opt as HTMLElement).dataset.tag || '';
        activeYear = activeYear === year ? '' : year;
        visibleCount = 12;

        document.querySelectorAll('.dropdown-item[data-tag]').forEach(o => {
          const isSelected = (o as HTMLElement).dataset.tag === activeYear;
          o.classList.toggle('active', isSelected);
          o.setAttribute('aria-selected', String(isSelected));
        });

        updateYearButton();
        closeDropdowns();
        filterPosts();
      });
    });

    // Search
    let searchDebounce: ReturnType<typeof setTimeout>;
    searchInput?.addEventListener('input', () => {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => {
        searchQuery = searchInput.value.trim();
        visibleCount = 12;
        clearSearch?.classList.toggle('hidden', !searchQuery);
        filterPosts();
      }, 200);
    });

    clearSearch?.addEventListener('click', () => {
      searchQuery = '';
      if (searchInput) searchInput.value = '';
      clearSearch.classList.add('hidden');
      searchInput?.focus();
      filterPosts();
    });

    // OA filter
    oaFilter?.addEventListener('click', () => {
      openAccessOnly = !openAccessOnly;
      visibleCount = 12;
      oaFilter.classList.toggle('active', openAccessOnly);
      oaFilter.setAttribute('aria-pressed', String(openAccessOnly));
      filterPosts();
    });

    // Sort
    sortSelect?.addEventListener('change', () => {
      sortOrder = sortSelect.value;
      filterPosts();
    });

    // Load more
    loadBtn?.addEventListener('click', () => {
      loadBtn.classList.add('loading');
      setTimeout(() => {
        visibleCount += 12;
        filterPosts();
        loadBtn.classList.remove('loading');
      }, 300);
    });

    // Clear all button
    clearAllBtn?.addEventListener('click', clearAll);

    // Init
    filterPosts();
  };

  initNewsPage();
  document.addEventListener('astro:after-swap', initNewsPage);
</script>
