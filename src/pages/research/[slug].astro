---
import Layout from '@layouts/Layout.astro';
import Breadcrumbs from '@components/layout/Breadcrumbs.astro';
import { researchThemes } from '@data/research';
import { publications } from '@data/publications';

export function getStaticPaths() {
  return researchThemes.map((theme) => ({
    params: { slug: theme.slug },
    props: { theme },
  }));
}

const { theme } = Astro.props;

// Map slug to publication theme
const themeToPublicationMap: Record<string, string> = {
  'coral-reefs': 'Coral',
  'kelp-forests': 'Kelp',
};

const publicationTheme = themeToPublicationMap[theme.slug] || theme.title;

// Get related publications (matching theme, sorted by year and citations)
const relatedPubs = publications
  .filter(pub => pub.themes.some(t => t.toLowerCase().includes(publicationTheme.toLowerCase())))
  .sort((a, b) => b.year - a.year || (b.citationCount || 0) - (a.citationCount || 0))
  .slice(0, 6);

const breadcrumbs = [
  { label: 'Research', href: '/research' },
  { label: theme.title },
];
---

<Layout title={theme.title} description={theme.tagline}>
  <!-- Hero -->
  <section class="relative py-24 md:py-32 overflow-hidden">
    <div
      class="absolute inset-0 bg-cover bg-center parallax-bg"
      style={`background-image: url('${theme.heroImage}');`}
    >
      <div class="absolute inset-0 bg-gradient-to-b from-bg-primary/50 via-bg-primary/40 to-bg-primary/70"></div>
    </div>

    <div class="relative container text-white">
      <Breadcrumbs items={breadcrumbs} class="mb-6" />
      <h1 class="text-white mb-4 hero-title">{theme.title}</h1>
      <p class="text-xl text-white/80 max-w-3xl hero-tagline">{theme.tagline}</p>
    </div>
  </section>

  <!-- Overview -->
  <section class="section bg-surface">
    <div class="container">
      <div class="max-w-3xl scroll-reveal">
        <span class="eyebrow">Overview</span>
        <div class="prose prose-invert">
          {theme.description.split('\n\n').map((paragraph) => (
            <p class="text-lg text-muted leading-relaxed mb-4">
              {paragraph}
            </p>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Key Questions -->
  <section class="section bg-navy-highlight">
    <div class="container">
      <div class="text-center mb-12 scroll-reveal">
        <span class="eyebrow">Research Focus</span>
        <h2>Key Questions</h2>
      </div>

      <div class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
        {theme.questions.map((question, i) => (
          <div class={`question-card scroll-reveal stagger-${i + 1}`}>
            <span class="question-number">{i + 1}</span>
            <p class="text-ink font-medium">{question}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Key Findings -->
  <section class="section bg-surface">
    <div class="container">
      <div class="text-center mb-12 scroll-reveal">
        <span class="eyebrow">Discoveries</span>
        <h2>Key Findings</h2>
        <p class="text-sm text-muted mt-2 md:hidden">Tap cards to reveal details</p>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        {theme.findings.map((finding, i) => (
          <button
            type="button"
            class={`finding-card scroll-reveal stagger-${i + 1}`}
            aria-label={`${finding.title}. Tap to reveal details.`}
          >
            <div class="finding-front">
              <div class="finding-icon">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
              </div>
              <h3 class="finding-title">{finding.title}</h3>
              <p class="finding-summary">{finding.summary}</p>
              <span class="finding-hint hidden md:block">Hover for details</span>
              <span class="finding-hint md:hidden">Tap for details</span>
            </div>
            <div class="finding-back">
              <p class="finding-detail">{finding.detail}</p>
              <span class="finding-hint md:hidden mt-4">Tap to go back</span>
            </div>
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Related Publications -->
  {relatedPubs.length > 0 && (
    <section class="section bg-navy-highlight">
      <div class="container">
        <div class="text-center mb-12 scroll-reveal">
          <span class="eyebrow">Featured Research</span>
          <h2>Related Publications</h2>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {relatedPubs.map((pub, i) => (
            <article class={`pub-card scroll-reveal stagger-${(i % 3) + 1}`}>
              <div class="pub-year">{pub.year}</div>
              <h3 class="pub-title">{pub.title}</h3>
              <p class="pub-authors">{pub.authors.split(',').slice(0, 3).join(', ')}{pub.authors.split(',').length > 3 ? ' et al.' : ''}</p>
              <div class="pub-meta">
                <span class="pub-journal">{pub.journal}</span>
                {pub.citationCount && pub.citationCount > 0 && (
                  <span class="pub-citations">{pub.citationCount} citations</span>
                )}
              </div>
              {pub.doi && (
                <a
                  href={`https://doi.org/${pub.doi}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="pub-link"
                >
                  View Paper
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                </a>
              )}
            </article>
          ))}
        </div>

        <div class="text-center mt-10 scroll-reveal">
          <a href="/publications" class="btn btn-secondary">
            View All Publications
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- CTA -->
  <section class="section bg-navy-deep">
    <div class="container text-center">
      <h2 class="text-white mb-4 scroll-reveal">Want to Learn More?</h2>
      <p class="text-white/70 max-w-xl mx-auto mb-8 scroll-reveal">
        Explore our other research areas or get in touch to discuss potential collaborations.
      </p>
      <div class="flex flex-wrap justify-center gap-4 scroll-reveal">
        <a href="/research" class="btn btn-primary">
          All Research Areas
        </a>
        <a href="/join-us" class="btn btn-secondary">
          Join the Lab
        </a>
      </div>
    </div>
  </section>
</Layout>

<style>
  .hero-title {
    animation: fadeUp 0.6s ease-out forwards;
  }

  .hero-tagline {
    opacity: 0;
    animation: fadeUp 0.6s ease-out 0.2s forwards;
  }

  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .parallax-bg {
    transform: translateZ(0);
    will-change: transform;
  }

  .question-card {
    @apply flex gap-4 p-5 rounded-xl;
    @apply bg-surface-card border border-line;
    @apply transition-all duration-300;
  }

  .question-card:hover {
    @apply -translate-y-1 shadow-lg border-accent/30;
  }

  .question-number {
    @apply flex-shrink-0 w-8 h-8 rounded-full;
    @apply bg-accent/20 text-accent;
    @apply flex items-center justify-center font-bold text-sm;
  }

  /* Flip card styles */
  .finding-card {
    @apply relative h-64 rounded-xl w-full text-left cursor-pointer;
    perspective: 1000px;
    background: transparent;
    border: none;
    padding: 0;
  }

  .finding-card:focus {
    @apply outline-none ring-2 ring-accent ring-offset-2;
  }

  .finding-front,
  .finding-back {
    @apply absolute inset-0 rounded-xl p-6;
    @apply flex flex-col;
    backface-visibility: hidden;
    transition: transform 0.6s ease;
  }

  .finding-front {
    @apply bg-surface-card border border-line;
  }

  .finding-back {
    @apply bg-gradient-to-br from-accent/20 to-accent-2/20;
    @apply border border-accent/30;
    @apply justify-center;
    transform: rotateY(180deg);
  }

  /* Desktop: hover to flip */
  @media (min-width: 768px) {
    .finding-card:hover .finding-front,
    .finding-card:focus .finding-front {
      transform: rotateY(-180deg);
    }

    .finding-card:hover .finding-back,
    .finding-card:focus .finding-back {
      transform: rotateY(0deg);
    }
  }

  /* Mobile: tap to flip via .flipped class */
  @media (max-width: 767px) {
    .finding-card.flipped .finding-front {
      transform: rotateY(-180deg);
    }

    .finding-card.flipped .finding-back {
      transform: rotateY(0deg);
    }
  }

  .finding-icon {
    @apply w-12 h-12 rounded-xl mb-4;
    @apply bg-accent/20 text-accent;
    @apply flex items-center justify-center;
  }

  .finding-title {
    @apply font-bold text-lg text-ink mb-2;
  }

  .finding-summary {
    @apply text-sm text-muted flex-1;
  }

  .finding-hint {
    @apply text-xs text-accent font-medium mt-2;
  }

  .finding-detail {
    @apply text-sm text-ink leading-relaxed font-medium;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .hero-title,
    .hero-tagline {
      animation: none;
      opacity: 1;
    }

    .finding-front,
    .finding-back {
      transition: none;
    }

    .finding-card:hover .finding-front {
      transform: none;
    }

    .finding-card:hover .finding-back {
      transform: rotateY(180deg);
    }
  }

  /* Publication card styles */
  .pub-card {
    @apply flex flex-col p-5 rounded-xl;
    @apply bg-surface-card border border-line;
    @apply transition-all duration-300;
  }

  .pub-card:hover {
    @apply -translate-y-1 shadow-lg border-accent/30;
  }

  .pub-year {
    @apply text-xs font-bold text-accent mb-2;
  }

  .pub-title {
    @apply text-base font-bold text-ink mb-2 line-clamp-3;
  }

  .pub-authors {
    @apply text-sm text-muted mb-3 line-clamp-1;
  }

  .pub-meta {
    @apply flex items-center gap-3 text-xs text-muted-2 mb-4;
  }

  .pub-journal {
    @apply italic;
  }

  .pub-citations {
    @apply flex items-center gap-1;
  }

  .pub-link {
    @apply inline-flex items-center gap-2 text-sm font-medium;
    @apply text-accent hover:text-accent-2 no-underline;
    @apply mt-auto pt-2 border-t border-line;
  }
</style>

<script>
  // Parallax effect
  const initParallax = () => {
    const parallaxBg = document.querySelector('.parallax-bg') as HTMLElement;
    if (!parallaxBg) return;

    const handleScroll = () => {
      const scrolled = window.scrollY;
      const rate = scrolled * 0.3;
      parallaxBg.style.transform = `translateY(${rate}px)`;
    };

    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      window.addEventListener('scroll', handleScroll, { passive: true });
    }
  };

  // Tap-to-flip for finding cards on mobile
  const initFlipCards = () => {
    const isMobile = window.innerWidth < 768;
    const cards = document.querySelectorAll('.finding-card');

    cards.forEach((card) => {
      card.addEventListener('click', () => {
        if (isMobile) {
          card.classList.toggle('flipped');
        }
      });
    });
  };

  initParallax();
  initFlipCards();
  document.addEventListener('astro:after-swap', () => {
    initParallax();
    initFlipCards();
  });
</script>
