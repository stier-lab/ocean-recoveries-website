---
import Layout from '@layouts/Layout.astro';
import { posts } from '@data/posts';
import { studySystems, researchPillars } from '@data/research';

// Get 3 most recent news posts for carousel
const recentPosts = [...posts]
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
  .slice(0, 3);

// Format date helper
const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};
---

<Layout title="Home">
  <!-- Hero Section -->
  <section class="relative min-h-screen flex items-center justify-center overflow-hidden">
    <!-- Background Image with Parallax -->
    <div
      class="absolute inset-0 bg-cover bg-center bg-no-repeat parallax-bg"
      style="background-image: url('/images/coral-reef-panorama-anthias-fish.jpeg');"
    >
      <!-- Gradient Overlay -->
      <div class="absolute inset-0 bg-gradient-to-b from-bg-primary/60 via-bg-primary/40 to-bg-primary/70"></div>
    </div>

    <!-- Hero Content -->
    <div class="relative z-10 container text-center text-white px-4 py-20">
      <h1 class="hero-title text-white mb-4 opacity-0">
        Ocean Recoveries Lab
      </h1>
      <p class="hero-tagline text-2xl md:text-3xl font-semibold text-white/90 mb-6 opacity-0">
        Recovering ocean ecosystems
      </p>
      <p class="hero-description max-w-2xl mx-auto text-lg text-white/80 leading-relaxed mb-8 opacity-0">
        Field experiments × quantitative models × synthesis — combining science with community partnerships to help coral reefs and kelp forests regenerate.
      </p>
      <div class="hero-cta opacity-0">
        <a href="/research" class="btn btn-primary btn-lg">
          Explore Our Research
        </a>
      </div>
    </div>

    <!-- Scroll Indicator -->
    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 z-10">
      <a
        href="#research"
        class="flex flex-col items-center gap-2 text-white/70 hover:text-white transition-colors no-underline"
        aria-label="Scroll to learn more"
      >
        <span class="text-sm font-medium">Explore</span>
        <svg
          class="w-6 h-6 animate-bounce-subtle"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
        </svg>
      </a>
    </div>
  </section>

  <!-- Study Systems Section -->
  <section id="research" class="section bg-surface">
    <div class="container">
      <div class="text-center mb-12 scroll-reveal">
        <span class="eyebrow">Where We Work</span>
        <h2>Study Systems</h2>
        <p class="lead max-w-2xl mx-auto">
          We conduct research in coral reef and kelp forest ecosystems, combining field experiments with quantitative models.
        </p>
      </div>

      <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
        {studySystems.map((system, i) => (
          <a href={`/research/${system.slug}`} class={`study-system-card scroll-reveal stagger-${i + 1} group`}>
            <div class="study-system-image img-zoom">
              <img
                src={system.heroImage}
                alt={system.title}
                loading="lazy"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-bg-primary/80 via-bg-primary/20 to-transparent"></div>
            </div>
            <div class="study-system-content">
              <h3 class="text-2xl text-white mb-2 group-hover:text-accent-2 transition-colors">{system.title}</h3>
              <p class="text-white/80 text-sm mb-3">
                {system.tagline}
              </p>
              <span class="inline-flex items-center gap-2 text-accent text-sm font-semibold opacity-0 group-hover:opacity-100 transition-opacity">
                Explore
                <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </span>
            </div>
          </a>
        ))}
      </div>

      <div class="text-center mt-10 scroll-reveal">
        <a href="/research" class="btn btn-secondary">
          Explore Our Research
        </a>
      </div>
    </div>
  </section>

  <!-- Research Pillars Section -->
  <section class="section bg-navy-deep overflow-hidden">
    <div class="container">
      <div class="text-center mb-12 scroll-reveal">
        <span class="eyebrow text-accent-2">How We Work</span>
        <h2 class="text-white">Three Research Pillars</h2>
        <p class="lead max-w-2xl mx-auto text-white/70">
          Our work integrates across three interconnected approaches — from understanding ecosystems to informing decisions.
        </p>
      </div>

      <div class="pillars-simple">
        {researchPillars.map((pillar, i) => (
          <div class={`pillar-item scroll-reveal stagger-${i + 1}`}>
            <span class="pillar-num">{i + 1}</span>
            <h3 class="pillar-name">{pillar.title}</h3>
          </div>
        ))}
      </div>

      <div class="text-center mt-12 scroll-reveal">
        <a href="/research#orl-pillars" class="btn btn-secondary">
          Learn More About Our Approach
        </a>
      </div>
    </div>
  </section>

  <!-- Recent News Carousel -->
  <section class="section bg-navy-highlight overflow-hidden">
    <div class="container">
      <div class="text-center mb-10 scroll-reveal">
        <span class="eyebrow text-accent-2">Latest News</span>
        <h2 class="text-white">Recent Work</h2>
      </div>

      <!-- Carousel Container -->
      <div class="news-carousel relative" aria-label="Recent news carousel">
        <!-- Slides -->
        <div class="carousel-track">
          {recentPosts.map((post, i) => (
            <article
              class={`carousel-slide ${i === 0 ? 'active' : ''}`}
              data-index={i}
              aria-hidden={i !== 0}
            >
              <a href={`/news/${post.slug}`} class="carousel-card group">
                <div class="carousel-image">
                  <img
                    src={post.featuredImage}
                    alt={post.title}
                    loading={i === 0 ? 'eager' : 'lazy'}
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-bg-primary/90 via-bg-primary/40 to-transparent"></div>
                </div>
                <div class="carousel-content">
                  <div class="flex flex-wrap gap-2 mb-3">
                    {post.tags.slice(0, 2).map(tag => (
                      <span class="badge badge-sm">{tag}</span>
                    ))}
                  </div>
                  <h3 class="text-xl md:text-2xl font-bold text-white mb-3 group-hover:text-accent-2 transition-colors line-clamp-2">
                    {post.title}
                  </h3>
                  <p class="text-white/70 text-sm mb-4 line-clamp-2 hidden sm:block">
                    {post.excerpt}
                  </p>
                  <div class="flex items-center justify-between">
                    <span class="text-white/50 text-sm">{formatDate(post.date)}</span>
                    <span class="text-accent font-semibold text-sm group-hover:translate-x-1 transition-transform inline-flex items-center gap-1">
                      Read more
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                      </svg>
                    </span>
                  </div>
                </div>
              </a>
            </article>
          ))}
        </div>

        <!-- Navigation Dots -->
        <div class="carousel-dots" role="tablist" aria-label="Carousel navigation">
          {recentPosts.map((_, i) => (
            <button
              class={`carousel-dot ${i === 0 ? 'active' : ''}`}
              data-index={i}
              role="tab"
              aria-selected={i === 0}
              aria-label={`Go to slide ${i + 1}`}
            />
          ))}
        </div>

        <!-- Progress Bar -->
        <div class="carousel-progress">
          <div class="carousel-progress-bar"></div>
        </div>
      </div>

      <div class="text-center mt-8 scroll-reveal">
        <a href="/news" class="btn btn-secondary">
          View All News
        </a>
      </div>
    </div>
  </section>

  <!-- Impact Metrics Section -->
  <section class="section bg-navy-highlight">
    <div class="container">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <div class="scroll-reveal">
          <span class="eyebrow">Our Lab</span>
          <h2 class="mb-6">Based at UC Santa Barbara</h2>
          <p class="text-muted mb-4">
            The Ocean Recoveries Lab is part of the Department of Ecology, Evolution & Marine Biology.
            We benefit from UCSB's world-class marine research facilities, the Santa Barbara Coastal
            Long-Term Ecological Research site, and partnerships with the Moorea Coral Reef LTER.
          </p>
          <p class="text-muted mb-6">
            Our team includes postdocs, graduate students, undergraduates, and collaborators working
            on decision-relevant science for reef and kelp forest conservation.
          </p>
          <a href="/people" class="btn btn-primary group">
            Meet the Team
            <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="stat-card scroll-reveal stagger-1">
            <span class="stat-number" data-target="75">0</span>
            <span class="stat-label">Publications</span>
          </div>
          <div class="stat-card scroll-reveal stagger-2">
            <span class="stat-number" data-target="15">0</span>
            <span class="stat-label">Years of Research</span>
          </div>
          <div class="stat-card scroll-reveal stagger-3">
            <span class="stat-number" data-target="2">0</span>
            <span class="stat-label">LTER Sites</span>
          </div>
          <div class="stat-card scroll-reveal stagger-4">
            <span class="stat-number" data-target="30">0</span>
            <span class="stat-label">Lab Alumni</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Join Us CTA -->
  <section class="section bg-navy-deep">
    <div class="container text-center">
      <h2 class="text-white mb-4 scroll-reveal">Join Our Team</h2>
      <p class="text-white/70 max-w-xl mx-auto mb-8 scroll-reveal">
        We're looking for curious, motivated researchers at all career stages who want to help understand and restore ocean ecosystems.
      </p>
      <a href="/join-us" class="btn btn-primary scroll-reveal">
        View Opportunities
      </a>
    </div>
  </section>
</Layout>

<style>
  /* Hero animations */
  .hero-title {
    animation: fadeUp 0.8s ease-out 0.2s forwards;
  }

  .hero-tagline {
    animation: fadeUp 0.8s ease-out 0.4s forwards;
  }

  .hero-description {
    animation: fadeUp 0.8s ease-out 0.6s forwards;
  }

  .hero-cta {
    animation: fadeUp 0.8s ease-out 0.8s forwards;
  }

  .btn-lg {
    @apply px-8 py-4 text-lg;
  }

  @keyframes fadeUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Parallax effect */
  .parallax-bg {
    transform: translateZ(0);
    will-change: transform;
  }

  /* Stat cards */
  .stat-card {
    @apply bg-surface-card rounded-lg p-6 text-center shadow;
    @apply transition-all duration-300 hover:-translate-y-1 hover:shadow-lg;
  }

  .stat-number {
    @apply block text-4xl md:text-5xl font-black text-accent mb-2;
  }

  .stat-label {
    @apply text-sm font-semibold text-muted uppercase tracking-wide;
  }

  /* Study System cards */
  .study-system-card {
    @apply relative rounded-xl overflow-hidden aspect-[4/3] no-underline block;
    @apply transition-all duration-300 hover:-translate-y-2 hover:shadow-xl;
  }

  .study-system-image {
    @apply absolute inset-0;
  }

  .study-system-image img {
    @apply w-full h-full object-cover;
  }

  .study-system-content {
    @apply absolute bottom-0 left-0 right-0 p-6;
  }

  /* News Carousel */
  .news-carousel {
    @apply max-w-4xl mx-auto;
  }

  .carousel-track {
    @apply relative;
    min-height: 400px;
  }

  .carousel-slide {
    @apply absolute inset-0 opacity-0 pointer-events-none;
    transition: opacity 0.5s ease-in-out;
  }

  .carousel-slide.active {
    @apply opacity-100 pointer-events-auto relative;
  }

  .carousel-card {
    @apply block rounded-xl overflow-hidden no-underline;
    @apply bg-surface-card/10 backdrop-blur-sm;
    @apply transition-all duration-300 hover:shadow-2xl;
  }

  .carousel-image {
    @apply relative aspect-[16/9] overflow-hidden;
  }

  .carousel-image img {
    @apply w-full h-full object-cover;
    @apply transition-transform duration-500;
  }

  .carousel-card:hover .carousel-image img {
    @apply scale-105;
  }

  .carousel-content {
    @apply p-6 md:p-8;
  }

  .carousel-dots {
    @apply flex justify-center gap-3 mt-6;
  }

  .carousel-dot {
    @apply w-3 h-3 rounded-full bg-white/30 border-0 cursor-pointer;
    @apply transition-all duration-300;
  }

  .carousel-dot:hover {
    @apply bg-white/50;
  }

  .carousel-dot.active {
    @apply bg-accent w-8;
  }

  .carousel-progress {
    @apply mt-4 h-1 bg-white/10 rounded-full overflow-hidden max-w-xs mx-auto;
  }

  .carousel-progress-bar {
    @apply h-full bg-accent rounded-full;
    width: 0%;
    transition: width 0.1s linear;
  }

  .carousel-progress-bar.animating {
    animation: progressFill 6s linear forwards;
  }

  @keyframes progressFill {
    from { width: 0%; }
    to { width: 100%; }
  }

  .badge-sm {
    @apply text-xs px-2 py-0.5;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Research Pillars - Homepage (simplified) */
  .pillars-simple {
    @apply flex flex-col md:flex-row justify-center items-stretch gap-4 md:gap-6 max-w-4xl mx-auto;
  }

  .pillar-item {
    @apply flex items-center gap-4 px-6 py-5 rounded-xl;
    @apply bg-white/5 border border-white/10;
    @apply transition-all duration-300;
    @apply hover:bg-white/10 hover:border-accent/30;
  }

  .pillar-num {
    @apply flex-shrink-0 w-10 h-10 rounded-full;
    @apply bg-accent text-white text-lg font-bold;
    @apply flex items-center justify-center;
  }

  .pillar-name {
    @apply text-white text-base lg:text-lg font-semibold m-0;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .hero-title,
    .hero-tagline,
    .hero-description {
      animation: none;
      opacity: 1;
    }

    .animate-bounce-subtle {
      animation: none;
    }

    .carousel-slide {
      transition: none;
    }

    .carousel-progress-bar.animating {
      animation: none;
      width: 100%;
    }
  }
</style>

<script>
  // Parallax effect for hero
  const initParallax = () => {
    const parallaxBg = document.querySelector('.parallax-bg') as HTMLElement;
    if (!parallaxBg) return;

    const handleScroll = () => {
      const scrolled = window.scrollY;
      const rate = scrolled * 0.4;
      parallaxBg.style.transform = `translateY(${rate}px)`;
    };

    // Check for reduced motion preference
    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      window.addEventListener('scroll', handleScroll, { passive: true });
    }
  };

  // Count-up animation for stats
  const initCountUp = () => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const el = entry.target as HTMLElement;
            const target = parseInt(el.dataset.target || '0', 10);
            animateCount(el, target);
            observer.unobserve(el);
          }
        });
      },
      { threshold: 0.5 }
    );

    document.querySelectorAll('.stat-number[data-target]').forEach((el) => {
      observer.observe(el);
    });
  };

  const animateCount = (el: HTMLElement, target: number) => {
    const duration = 1500;
    const start = performance.now();

    const update = (currentTime: number) => {
      const elapsed = currentTime - start;
      const progress = Math.min(elapsed / duration, 1);

      // Easing function (ease-out)
      const eased = 1 - Math.pow(1 - progress, 3);
      const current = Math.round(eased * target);

      el.textContent = current.toString();

      if (progress < 1) {
        requestAnimationFrame(update);
      }
    };

    // Check for reduced motion
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      el.textContent = target.toString();
    } else {
      requestAnimationFrame(update);
    }
  };

  // News Carousel
  const initCarousel = () => {
    const carousel = document.querySelector('.news-carousel');
    if (!carousel) return;

    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = carousel.querySelectorAll('.carousel-dot');
    const progressBar = carousel.querySelector('.carousel-progress-bar') as HTMLElement;

    if (slides.length === 0) return;

    let currentIndex = 0;
    let intervalId: number | null = null;
    let isPaused = false;
    const INTERVAL = 6000; // 6 seconds per slide

    const goToSlide = (index: number) => {
      // Update slides
      slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === index);
        slide.setAttribute('aria-hidden', String(i !== index));
      });

      // Update dots
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
        dot.setAttribute('aria-selected', String(i === index));
      });

      // Reset progress bar
      if (progressBar) {
        progressBar.classList.remove('animating');
        // Force reflow
        void progressBar.offsetWidth;
        progressBar.classList.add('animating');
      }

      currentIndex = index;
    };

    const nextSlide = () => {
      const next = (currentIndex + 1) % slides.length;
      goToSlide(next);
    };

    const startAutoPlay = () => {
      if (intervalId) clearInterval(intervalId);
      intervalId = window.setInterval(() => {
        if (!isPaused) {
          nextSlide();
        }
      }, INTERVAL);

      // Start progress animation
      if (progressBar) {
        progressBar.classList.add('animating');
      }
    };

    const pauseAutoPlay = () => {
      isPaused = true;
      if (progressBar) {
        progressBar.style.animationPlayState = 'paused';
      }
    };

    const resumeAutoPlay = () => {
      isPaused = false;
      if (progressBar) {
        progressBar.style.animationPlayState = 'running';
      }
    };

    // Dot click handlers
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        goToSlide(index);
        startAutoPlay(); // Reset timer on manual navigation
      });
    });

    // Pause on hover
    carousel.addEventListener('mouseenter', pauseAutoPlay);
    carousel.addEventListener('mouseleave', resumeAutoPlay);

    // Pause on focus (accessibility)
    carousel.addEventListener('focusin', pauseAutoPlay);
    carousel.addEventListener('focusout', resumeAutoPlay);

    // Touch/swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    carousel.addEventListener('touchstart', (e) => {
      const te = e as TouchEvent;
      touchStartX = te.changedTouches[0].screenX;
    }, { passive: true });

    carousel.addEventListener('touchend', (e) => {
      const te = e as TouchEvent;
      touchEndX = te.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          // Swipe left - next
          goToSlide((currentIndex + 1) % slides.length);
        } else {
          // Swipe right - previous
          goToSlide((currentIndex - 1 + slides.length) % slides.length);
        }
        startAutoPlay();
      }
    }, { passive: true });

    // Keyboard navigation
    carousel.addEventListener('keydown', (e) => {
      const ke = e as KeyboardEvent;
      if (ke.key === 'ArrowLeft') {
        goToSlide((currentIndex - 1 + slides.length) % slides.length);
        startAutoPlay();
      } else if (ke.key === 'ArrowRight') {
        goToSlide((currentIndex + 1) % slides.length);
        startAutoPlay();
      }
    });

    // Check for reduced motion preference
    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      startAutoPlay();
    } else {
      // Still allow manual navigation but no auto-play
      if (progressBar) {
        progressBar.style.display = 'none';
      }
    }

    // Cleanup on page navigation
    return () => {
      if (intervalId) clearInterval(intervalId);
    };
  };

  // Initialize
  initParallax();
  initCountUp();
  initCarousel();

  // Re-init after view transitions
  document.addEventListener('astro:after-swap', () => {
    initParallax();
    initCountUp();
    initCarousel();
  });
</script>
