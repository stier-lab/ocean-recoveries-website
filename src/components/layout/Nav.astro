---
const currentPath = Astro.url.pathname;

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/research', label: 'Research' },
  { href: '/people', label: 'People' },
  { href: '/publications', label: 'Publications' },
  { href: '/news', label: 'News' },
  { href: '/join-us', label: 'Join Us' },
];

const isActive = (href: string) => {
  if (href === '/') return currentPath === '/';
  return currentPath.startsWith(href);
};
---

<header
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300"
  id="nav-header"
  data-transparent="true"
>
  <nav class="container flex items-center justify-between h-16 md:h-20" aria-label="Main navigation">
    <!-- Logo -->
    <a
      href="/"
      class="flex items-center gap-2 text-ink font-black text-lg md:text-xl no-underline hover:no-underline transition-colors"
    >
      <span class="nav-logo-text">Ocean Recoveries</span>
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden md:flex items-center gap-1">
      {navLinks.map((link) => (
        <a
          href={link.href}
          class:list={[
            'nav-link relative px-3 py-2 text-sm font-semibold no-underline transition-colors duration-200',
            isActive(link.href)
              ? 'text-accent'
              : 'text-ink/80 hover:text-accent',
          ]}
          aria-current={isActive(link.href) ? 'page' : undefined}
        >
          {link.label}
          {isActive(link.href) && (
            <span class="absolute bottom-0 left-3 right-3 h-0.5 bg-accent rounded-full" />
          )}
        </a>
      ))}
    </div>

    <!-- Mobile Menu Button -->
    <button
      type="button"
      class="md:hidden p-2 -mr-2 text-ink"
      aria-label="Toggle navigation menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
      id="mobile-menu-button"
    >
      <svg
        class="w-6 h-6 hamburger-icon"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"
          class="hamburger-lines"
        />
      </svg>
      <svg
        class="w-6 h-6 close-icon hidden"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>
  </nav>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="md:hidden fixed inset-0 top-16 bg-surface/95 backdrop-blur-lg transform translate-x-full transition-transform duration-300 ease-spring"
    aria-hidden="true"
  >
    <nav class="container py-8 flex flex-col gap-2" aria-label="Mobile navigation">
      {navLinks.map((link, index) => (
        <a
          href={link.href}
          class:list={[
            'mobile-nav-link py-3 px-4 text-lg font-semibold no-underline rounded-xl transition-all duration-200',
            'opacity-0 translate-x-4',
            isActive(link.href)
              ? 'text-accent bg-accent/10'
              : 'text-ink hover:bg-line/50',
          ]}
          style={`transition-delay: ${index * 50}ms`}
          aria-current={isActive(link.href) ? 'page' : undefined}
        >
          {link.label}
        </a>
      ))}
    </nav>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-16 md:h-20"></div>

<style>
  /* Glassmorphism when scrolled */
  #nav-header.scrolled {
    @apply bg-surface/80 backdrop-blur-lg shadow-sm;
  }

  #nav-header.scrolled .nav-logo-text {
    @apply text-ink;
  }

  /* Transparent state (over hero) */
  #nav-header[data-transparent="true"]:not(.scrolled) {
    @apply bg-transparent;
  }

  #nav-header[data-transparent="true"]:not(.scrolled) .nav-logo-text,
  #nav-header[data-transparent="true"]:not(.scrolled) .nav-link {
    @apply text-white;
  }

  #nav-header[data-transparent="true"]:not(.scrolled) .nav-link.text-accent {
    @apply text-white;
  }

  /* Mobile menu open state */
  #mobile-menu.open {
    @apply translate-x-0;
  }

  #mobile-menu.open .mobile-nav-link {
    @apply opacity-100 translate-x-0;
  }

  /* Icon toggle */
  #mobile-menu-button[aria-expanded="true"] .hamburger-icon {
    @apply hidden;
  }

  #mobile-menu-button[aria-expanded="true"] .close-icon {
    @apply block;
  }
</style>

<script>
  const initNav = () => {
    const header = document.getElementById('nav-header');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');

    if (!header || !mobileMenuButton || !mobileMenu) return;

    // Handle scroll
    const handleScroll = () => {
      const scrolled = window.scrollY > 50;
      header.classList.toggle('scrolled', scrolled);
    };

    // Handle mobile menu toggle
    const toggleMobileMenu = () => {
      const isOpen = mobileMenu.classList.contains('open');

      mobileMenu.classList.toggle('open');
      mobileMenuButton.setAttribute('aria-expanded', String(!isOpen));
      mobileMenu.setAttribute('aria-hidden', String(isOpen));

      // Prevent body scroll when menu is open
      document.body.style.overflow = isOpen ? '' : 'hidden';
    };

    // Close mobile menu on link click
    const closeMobileMenu = () => {
      mobileMenu.classList.remove('open');
      mobileMenuButton.setAttribute('aria-expanded', 'false');
      mobileMenu.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    };

    // Event listeners
    window.addEventListener('scroll', handleScroll, { passive: true });
    mobileMenuButton.addEventListener('click', toggleMobileMenu);

    mobileMenu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', closeMobileMenu);
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileMenu.classList.contains('open')) {
        closeMobileMenu();
      }
    });

    // Initial check
    handleScroll();
  };

  // Run on load and after view transitions
  initNav();
  document.addEventListener('astro:after-swap', initNav);
</script>
