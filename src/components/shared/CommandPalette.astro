---
/**
 * Command Palette Component
 *
 * A Cmd+K / Ctrl+K activated search and quick navigation overlay.
 * Provides instant search across publications, news, and people.
 *
 * Usage: Include once in Layout.astro
 */

import { posts } from '@data/posts';
import { publications } from '@data/publications';
import { currentTeam } from '@data/team';

// Helper to get first author from authors string
const getFirstAuthor = (authors: string): string => {
  const firstAuthor = authors.split(',')[0].trim();
  return firstAuthor.split(' ').pop() || firstAuthor; // Get last name
};

// Build search index
const searchIndex = [
  // Pages
  { type: 'page', title: 'Home', url: '/', icon: 'home' },
  { type: 'page', title: 'Research', url: '/research', icon: 'beaker' },
  { type: 'page', title: 'People', url: '/people', icon: 'users' },
  { type: 'page', title: 'Publications', url: '/publications', icon: 'document' },
  { type: 'page', title: 'News', url: '/news', icon: 'newspaper' },
  { type: 'page', title: 'Join the Lab', url: '/join', icon: 'plus' },
  { type: 'page', title: 'For Funders', url: '/for-funders', icon: 'briefcase' },
  { type: 'page', title: 'Values', url: '/values', icon: 'heart' },
  { type: 'page', title: 'Coral Reefs', url: '/research/coral-reefs', icon: 'beaker' },
  { type: 'page', title: 'Kelp Forests', url: '/research/kelp-forests', icon: 'beaker' },

  // Team members
  ...currentTeam.map(member => ({
    type: 'person',
    title: member.name,
    subtitle: member.title,
    url: '/people',
    icon: 'user',
  })),

  // Recent publications (limit to 20 for performance)
  ...publications.slice(0, 20).map(pub => ({
    type: 'publication',
    title: pub.title.length > 60 ? pub.title.substring(0, 60) + '...' : pub.title,
    subtitle: `${getFirstAuthor(pub.authors)} et al. (${pub.year})`,
    url: pub.doi ? `https://doi.org/${pub.doi}` : `/publications`,
    icon: 'document',
    external: !!pub.doi,
  })),

  // Recent news (limit to 15)
  ...posts.slice(0, 15).map(post => ({
    type: 'news',
    title: post.title.length > 60 ? post.title.substring(0, 60) + '...' : post.title,
    subtitle: post.excerpt.substring(0, 50) + '...',
    url: `/news/${post.slug}`,
    icon: 'newspaper',
  })),
];
---

<!-- Command Palette Overlay -->
<div id="command-palette" class="cmd-overlay" role="dialog" aria-modal="true" aria-label="Search and navigate">
  <div class="cmd-backdrop"></div>

  <div class="cmd-container">
    <!-- Search Input -->
    <div class="cmd-header">
      <svg class="cmd-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input
        type="text"
        id="cmd-input"
        class="cmd-input"
        placeholder="Search pages, publications, news..."
        autocomplete="off"
        spellcheck="false"
      />
      <kbd class="cmd-kbd">ESC</kbd>
    </div>

    <!-- Results -->
    <div class="cmd-results" id="cmd-results" role="listbox">
      <!-- Quick Actions (shown when empty) -->
      <div class="cmd-section cmd-quick-actions" id="cmd-quick-actions">
        <div class="cmd-section-title">Quick Actions</div>
        <a href="/" class="cmd-item" role="option" data-index="0">
          <span class="cmd-item-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
          </span>
          <span class="cmd-item-content">
            <span class="cmd-item-title">Home</span>
          </span>
          <span class="cmd-item-type">Page</span>
        </a>
        <a href="/research" class="cmd-item" role="option" data-index="1">
          <span class="cmd-item-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
          </span>
          <span class="cmd-item-content">
            <span class="cmd-item-title">Research</span>
          </span>
          <span class="cmd-item-type">Page</span>
        </a>
        <a href="/publications" class="cmd-item" role="option" data-index="2">
          <span class="cmd-item-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
          </span>
          <span class="cmd-item-content">
            <span class="cmd-item-title">Publications</span>
          </span>
          <span class="cmd-item-type">Page</span>
        </a>
        <a href="/news" class="cmd-item" role="option" data-index="3">
          <span class="cmd-item-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" /></svg>
          </span>
          <span class="cmd-item-content">
            <span class="cmd-item-title">News & Research</span>
          </span>
          <span class="cmd-item-type">Page</span>
        </a>
        <a href="/people" class="cmd-item" role="option" data-index="4">
          <span class="cmd-item-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
          </span>
          <span class="cmd-item-content">
            <span class="cmd-item-title">People</span>
          </span>
          <span class="cmd-item-type">Page</span>
        </a>
        <a href="/join" class="cmd-item" role="option" data-index="5">
          <span class="cmd-item-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
          </span>
          <span class="cmd-item-content">
            <span class="cmd-item-title">Join the Lab</span>
          </span>
          <span class="cmd-item-type">Page</span>
        </a>
      </div>

      <!-- Search Results (populated dynamically) -->
      <div class="cmd-section cmd-search-results hidden" id="cmd-search-results">
        <div class="cmd-section-title">Results</div>
        <div id="cmd-results-list"></div>
      </div>

      <!-- No Results -->
      <div class="cmd-no-results hidden" id="cmd-no-results">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p>No results found</p>
      </div>
    </div>

    <!-- Footer -->
    <div class="cmd-footer">
      <div class="cmd-hint">
        <kbd>↑↓</kbd> to navigate
      </div>
      <div class="cmd-hint">
        <kbd>↵</kbd> to select
      </div>
      <div class="cmd-hint">
        <kbd>esc</kbd> to close
      </div>
    </div>
  </div>
</div>

<!-- Search Index (JSON in script tag for client-side access) -->
<script is:inline id="search-index" type="application/json" set:html={JSON.stringify(searchIndex)} />

<style>
  /* Overlay */
  .cmd-overlay {
    @apply fixed inset-0 z-[100] flex items-start justify-center pt-[15vh];
    @apply opacity-0 invisible pointer-events-none;
    @apply transition-all duration-200;
  }

  .cmd-overlay.open {
    @apply opacity-100 visible pointer-events-auto;
  }

  .cmd-backdrop {
    @apply absolute inset-0 bg-black/60 backdrop-blur-sm;
  }

  /* Container */
  .cmd-container {
    @apply relative w-full max-w-xl mx-4;
    @apply bg-surface-card border border-line rounded-2xl shadow-2xl overflow-hidden;
    @apply transform scale-95 transition-transform duration-200;
  }

  .cmd-overlay.open .cmd-container {
    @apply scale-100;
  }

  /* Header */
  .cmd-header {
    @apply flex items-center gap-3 px-4 py-3 border-b border-line;
  }

  .cmd-search-icon {
    @apply w-5 h-5 text-muted flex-shrink-0;
  }

  .cmd-input {
    @apply flex-1 bg-transparent text-ink text-base placeholder-muted;
    @apply border-none outline-none;
  }

  .cmd-kbd {
    @apply px-2 py-1 rounded text-xs font-mono text-muted bg-surface border border-line;
  }

  /* Results */
  .cmd-results {
    @apply max-h-[400px] overflow-y-auto;
  }

  .cmd-section {
    @apply py-2;
  }

  .cmd-section.hidden {
    display: none;
  }

  .cmd-section-title {
    @apply px-4 py-2 text-xs font-semibold text-muted uppercase tracking-wider;
  }

  /* Items */
  .cmd-item {
    @apply flex items-center gap-3 px-4 py-3 no-underline;
    @apply text-ink hover:bg-accent/10 cursor-pointer;
    @apply transition-colors;
  }

  .cmd-item.active {
    @apply bg-accent/10;
  }

  .cmd-item-icon {
    @apply w-8 h-8 flex items-center justify-center rounded-lg;
    @apply bg-surface text-muted flex-shrink-0;
  }

  .cmd-item-icon svg {
    @apply w-4 h-4;
  }

  .cmd-item.active .cmd-item-icon {
    @apply bg-accent/20 text-accent;
  }

  .cmd-item-content {
    @apply flex-1 min-w-0;
  }

  .cmd-item-title {
    @apply block text-sm font-medium truncate;
  }

  .cmd-item-subtitle {
    @apply block text-xs text-muted truncate mt-0.5;
  }

  .cmd-item-type {
    @apply text-xs text-muted flex-shrink-0;
  }

  /* No Results */
  .cmd-no-results {
    @apply flex flex-col items-center justify-center py-12 text-muted;
  }

  .cmd-no-results.hidden {
    display: none;
  }

  .cmd-no-results svg {
    @apply w-12 h-12 mb-3 opacity-50;
  }

  .cmd-no-results p {
    @apply text-sm;
  }

  /* Footer */
  .cmd-footer {
    @apply flex items-center justify-center gap-6 px-4 py-3;
    @apply border-t border-line bg-surface/50;
  }

  .cmd-hint {
    @apply flex items-center gap-2 text-xs text-muted;
  }

  .cmd-hint kbd {
    @apply px-1.5 py-0.5 rounded text-[10px] font-mono bg-surface border border-line;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .cmd-overlay,
    .cmd-container {
      transition: none;
    }
  }
</style>

<script>
  const initCommandPalette = () => {
    const overlay = document.getElementById('command-palette');
    const input = document.getElementById('cmd-input') as HTMLInputElement;
    const quickActions = document.getElementById('cmd-quick-actions');
    const searchResults = document.getElementById('cmd-search-results');
    const resultsList = document.getElementById('cmd-results-list');
    const noResults = document.getElementById('cmd-no-results');

    // Load search index
    const indexScript = document.getElementById('search-index');
    const searchIndex = indexScript ? JSON.parse(indexScript.textContent || '[]') : [];

    let activeIndex = 0;
    let currentItems: HTMLElement[] = [];

    // Open/close functions
    const open = () => {
      overlay?.classList.add('open');
      input?.focus();
      document.body.style.overflow = 'hidden';
      updateActiveItems();
    };

    const close = () => {
      overlay?.classList.remove('open');
      if (input) input.value = '';
      document.body.style.overflow = '';
      resetSearch();
    };

    const isOpen = () => overlay?.classList.contains('open');

    // Reset to initial state
    const resetSearch = () => {
      quickActions?.classList.remove('hidden');
      searchResults?.classList.add('hidden');
      noResults?.classList.add('hidden');
      activeIndex = 0;
      updateActiveItems();
    };

    // Search function
    const search = (query: string) => {
      if (!query.trim()) {
        resetSearch();
        return;
      }

      const q = query.toLowerCase();
      const results = searchIndex.filter((item: any) =>
        item.title.toLowerCase().includes(q) ||
        (item.subtitle && item.subtitle.toLowerCase().includes(q))
      ).slice(0, 10);

      quickActions?.classList.add('hidden');

      if (results.length === 0) {
        searchResults?.classList.add('hidden');
        noResults?.classList.remove('hidden');
        currentItems = [];
        return;
      }

      noResults?.classList.add('hidden');
      searchResults?.classList.remove('hidden');

      // Render results
      if (resultsList) {
        resultsList.innerHTML = results.map((item: any, i: number) => `
          <a href="${item.url}" class="cmd-item" role="option" data-index="${i}"${item.external ? ' target="_blank" rel="noopener noreferrer"' : ''}>
            <span class="cmd-item-icon">
              ${getIcon(item.type)}
            </span>
            <span class="cmd-item-content">
              <span class="cmd-item-title">${escapeHtml(item.title)}</span>
              ${item.subtitle ? `<span class="cmd-item-subtitle">${escapeHtml(item.subtitle)}</span>` : ''}
            </span>
            <span class="cmd-item-type">${item.type}</span>
          </a>
        `).join('');
      }

      activeIndex = 0;
      updateActiveItems();
    };

    // Get icon SVG for type
    const getIcon = (type: string) => {
      const icons: Record<string, string> = {
        page: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>',
        publication: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>',
        news: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" /></svg>',
        person: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>',
      };
      return icons[type] || icons.page;
    };

    // HTML escape helper
    const escapeHtml = (str: string) => {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    };

    // Update active item highlighting
    const updateActiveItems = () => {
      // Get all visible items
      const container = searchResults?.classList.contains('hidden') ? quickActions : resultsList;
      currentItems = Array.from(container?.querySelectorAll('.cmd-item') || []) as HTMLElement[];

      // Update active states
      currentItems.forEach((item, i) => {
        item.classList.toggle('active', i === activeIndex);
      });
    };

    // Navigate selection
    const navigate = (direction: 'up' | 'down') => {
      if (currentItems.length === 0) return;

      if (direction === 'down') {
        activeIndex = (activeIndex + 1) % currentItems.length;
      } else {
        activeIndex = (activeIndex - 1 + currentItems.length) % currentItems.length;
      }

      updateActiveItems();
      currentItems[activeIndex]?.scrollIntoView({ block: 'nearest' });
    };

    // Select current item
    const selectCurrent = () => {
      const item = currentItems[activeIndex];
      if (item) {
        const href = item.getAttribute('href');
        if (href) {
          close();
          // Use Astro's client-side navigation if available
          if (item.getAttribute('target') === '_blank') {
            window.open(href, '_blank', 'noopener,noreferrer');
          } else {
            window.location.href = href;
          }
        }
      }
    };

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Open with Cmd/Ctrl + K
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (isOpen()) {
          close();
        } else {
          open();
        }
        return;
      }

      // If not open, ignore other shortcuts
      if (!isOpen()) return;

      // Close with Escape
      if (e.key === 'Escape') {
        e.preventDefault();
        close();
        return;
      }

      // Navigate with arrows
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigate('down');
        return;
      }

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigate('up');
        return;
      }

      // Select with Enter
      if (e.key === 'Enter') {
        e.preventDefault();
        selectCurrent();
        return;
      }
    });

    // Click backdrop to close
    overlay?.querySelector('.cmd-backdrop')?.addEventListener('click', close);

    // Search input
    let debounceTimer: ReturnType<typeof setTimeout>;
    input?.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        search(input.value);
      }, 150);
    });

    // Mouse hover on items
    overlay?.addEventListener('mousemove', (e) => {
      const item = (e.target as HTMLElement).closest('.cmd-item');
      if (item) {
        const index = parseInt(item.getAttribute('data-index') || '0', 10);
        if (index !== activeIndex) {
          activeIndex = index;
          updateActiveItems();
        }
      }
    });

    // Initialize
    updateActiveItems();
  };

  // Initialize on load and after view transitions
  initCommandPalette();
  document.addEventListener('astro:after-swap', initCommandPalette);
</script>
